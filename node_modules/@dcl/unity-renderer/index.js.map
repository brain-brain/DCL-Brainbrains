{"version":3,"file":"index.js","sources":["../node_modules/fp-future/index.js","../src/index.ts"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nfunction future() {\n    let resolver;\n    let rejecter;\n    const promise = new Promise((ok, err) => {\n        resolver = (x) => {\n            ok(x);\n            promise.isPending = false;\n        };\n        rejecter = (x) => {\n            err(x);\n            promise.isPending = false;\n        };\n    }).catch(e => Promise.reject(e));\n    promise.resolve = resolver;\n    promise.reject = rejecter;\n    if (!(\"finally\" in promise)) {\n        promise.finally = fn => {\n            promise.then(fn);\n            promise.catch(fn);\n        };\n    }\n    promise.isPending = true;\n    return promise;\n}\nexports.future = future;\nexports.default = future;\n//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQU9BLFNBQWdCLE1BQU07SUFDcEIsSUFBSSxRQUF3QixDQUFDO0lBQzdCLElBQUksUUFBNEIsQ0FBQztJQUVqQyxNQUFNLE9BQU8sR0FBUSxJQUFJLE9BQU8sQ0FBQyxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRTtRQUMzQyxRQUFRLEdBQUcsQ0FBQyxDQUFJLEVBQUUsRUFBRTtZQUNsQixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDTixPQUFPLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztRQUM1QixDQUFDLENBQUM7UUFDRixRQUFRLEdBQUcsQ0FBQyxDQUFRLEVBQUUsRUFBRTtZQUN0QixHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDUCxPQUFPLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztRQUM1QixDQUFDLENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFakMsT0FBTyxDQUFDLE9BQU8sR0FBRyxRQUFRLENBQUM7SUFDM0IsT0FBTyxDQUFDLE1BQU0sR0FBRyxRQUFRLENBQUM7SUFFMUIsSUFBSSxDQUFDLENBQUMsU0FBUyxJQUFJLE9BQU8sQ0FBQyxFQUFFO1FBQzNCLE9BQU8sQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDLEVBQUU7WUFDckIsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNqQixPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3BCLENBQUMsQ0FBQztLQUNIO0lBRUQsT0FBTyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7SUFFekIsT0FBTyxPQUFxQixDQUFDO0FBQy9CLENBQUM7QUE1QkQsd0JBNEJDO0FBRUQsa0JBQWUsTUFBTSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IHR5cGUgSUZ1dHVyZTxUPiA9IFByb21pc2U8VD4gJiB7XG4gIHJlc29sdmU6ICh4OiBUKSA9PiB2b2lkO1xuICByZWplY3Q6ICh4OiBFcnJvcikgPT4gdm9pZDtcbiAgZmluYWxseTogKGZuOiAoKSA9PiB2b2lkKSA9PiB2b2lkO1xuICBpc1BlbmRpbmc6IGJvb2xlYW47XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gZnV0dXJlPFQgPSBhbnk+KCk6IElGdXR1cmU8VD4ge1xuICBsZXQgcmVzb2x2ZXI6ICh4OiBUKSA9PiB2b2lkO1xuICBsZXQgcmVqZWN0ZXI6ICh4OiBFcnJvcikgPT4gdm9pZDtcblxuICBjb25zdCBwcm9taXNlOiBhbnkgPSBuZXcgUHJvbWlzZSgob2ssIGVycikgPT4ge1xuICAgIHJlc29sdmVyID0gKHg6IFQpID0+IHtcbiAgICAgIG9rKHgpO1xuICAgICAgcHJvbWlzZS5pc1BlbmRpbmcgPSBmYWxzZTtcbiAgICB9O1xuICAgIHJlamVjdGVyID0gKHg6IEVycm9yKSA9PiB7XG4gICAgICBlcnIoeCk7XG4gICAgICBwcm9taXNlLmlzUGVuZGluZyA9IGZhbHNlO1xuICAgIH07XG4gIH0pLmNhdGNoKGUgPT4gUHJvbWlzZS5yZWplY3QoZSkpO1xuXG4gIHByb21pc2UucmVzb2x2ZSA9IHJlc29sdmVyO1xuICBwcm9taXNlLnJlamVjdCA9IHJlamVjdGVyO1xuXG4gIGlmICghKFwiZmluYWxseVwiIGluIHByb21pc2UpKSB7XG4gICAgcHJvbWlzZS5maW5hbGx5ID0gZm4gPT4ge1xuICAgICAgcHJvbWlzZS50aGVuKGZuKTtcbiAgICAgIHByb21pc2UuY2F0Y2goZm4pO1xuICAgIH07XG4gIH1cblxuICBwcm9taXNlLmlzUGVuZGluZyA9IHRydWU7XG5cbiAgcmV0dXJuIHByb21pc2UgYXMgSUZ1dHVyZTxUPjtcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnV0dXJlO1xuIl19","// This compilated file is appended to the unity.loader.js. You can\n// assume everything from the loader will be available here\n\nimport future from \"fp-future\"\n\n// the following function is defined by unity, accessible via unity.loader.js\n// https://docs.unity3d.com/Manual/webgl-templates.html\n// prettier-ignore\ndeclare function createUnityInstance(canvas: HTMLCanvasElement, config: any, onProgress?: (progress: number) => void, onSuccess?: (unityInstance: any) => void, onError?: (message: any) => void): Promise<UnityGame>\n\n/** Expose the original interface from the Unity Instance. */\nexport type UnityGame = {\n  Module: {\n    /** this handler can be overwritten, return true to stop error propagation */\n    errorHandler?: (message: string, filename: string, lineno: number) => boolean\n  }\n  SendMessage(object: string, method: string, args: number | string): void\n  SetFullscreen(): void\n  Quit(): Promise<void>\n}\n\nexport type RendererOptions = {\n  canvas: HTMLCanvasElement\n\n  onProgress?: (progress: number) => void\n  onSuccess?: (unityInstance: any) => void\n  onError?: (error: any) => void\n  /** Legacy messaging system */\n  onMessageLegacy: (type: string, payload: string) => void\n  /** used to append a ?v={} to the URL. Useful to debug cache issues */\n  versionQueryParam?: string\n  /** baseUrl where all the assets are deployed */\n  baseUrl: string\n}\n\nexport type DecentralandRendererInstance = {\n  /**\n   * Signal sent by unity after it started correctly\n   * it is a promise, that makes it awaitable.\n   * The content of the resolved promise is an empty object to\n   * enable future extensions.\n   */\n  engineStartedFuture: Promise<{}>\n\n  // soon there will be more protocol functions here https://github.com/decentraland/renderer-protocol\n  // and originalUnity will be deprecated to decouple the kernel from unity's impl internals\n  originalUnity: UnityGame\n}\n\nexport async function initializeWebRenderer(options: RendererOptions): Promise<DecentralandRendererInstance> {\n  const rendererVersion = options.versionQueryParam || performance.now()\n  const { canvas, baseUrl, onProgress, onSuccess, onError, onMessageLegacy } = options\n  const resolveWithBaseUrl = (file: string) => new URL(file + \"?v=\" + rendererVersion, baseUrl).toString()\n\n  const config = {\n    dataUrl: resolveWithBaseUrl(\"unity.data.unityweb\"),\n    frameworkUrl: resolveWithBaseUrl(\"unity.framework.js.unityweb\"),\n    codeUrl: resolveWithBaseUrl(\"unity.wasm.unityweb\"),\n    streamingAssetsUrl: resolveWithBaseUrl(\"StreamingAssets\"),\n    companyName: \"Decentraland\",\n    productName: \"Decentraland World Client\",\n    productVersion: \"0.1\",\n  }\n\n  const engineStartedFuture = future<{}>()\n\n  // The namespace DCL is exposed to global because the unity template uses it to send the messages\n  // @see https://github.com/decentraland/unity-renderer/blob/bc2bf1ee0d685132c85606055e592bac038b3471/unity-renderer/Assets/Plugins/JSFunctions.jslib#L6-L29\n  ;(globalThis as any)[\"DCL\"] = {\n    // This function get's called by the engine\n    EngineStarted() {\n      engineStartedFuture.resolve({})\n    },\n\n    // This function is called from the unity renderer to send messages back to the scenes\n    MessageFromEngine(type: string, jsonEncodedMessage: string) {\n      onMessageLegacy(type, jsonEncodedMessage)\n    },\n  }\n\n  const originalUnity = await createUnityInstance(canvas, config, onProgress, onSuccess, onError)\n\n  // TODO: replace originalUnity.errorHandler with a version that redirects errors to -> onError\n\n  return {\n    engineStartedFuture,\n    originalUnity,\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;CACA,MAAM,CAAC,cAAc,CAAC,OAAO,EAAE,YAAY,EAAE,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;CAC9D,SAAS,MAAM,GAAG;CAClB,IAAI,IAAI,QAAQ,CAAC;CACjB,IAAI,IAAI,QAAQ,CAAC;CACjB,IAAI,MAAM,OAAO,GAAG,IAAI,OAAO,CAAC,CAAC,EAAE,EAAE,GAAG,KAAK;CAC7C,QAAQ,QAAQ,GAAG,CAAC,CAAC,KAAK;CAC1B,YAAY,EAAE,CAAC,CAAC,CAAC,CAAC;CAClB,YAAY,OAAO,CAAC,SAAS,GAAG,KAAK,CAAC;CACtC,SAAS,CAAC;CACV,QAAQ,QAAQ,GAAG,CAAC,CAAC,KAAK;CAC1B,YAAY,GAAG,CAAC,CAAC,CAAC,CAAC;CACnB,YAAY,OAAO,CAAC,SAAS,GAAG,KAAK,CAAC;CACtC,SAAS,CAAC;CACV,KAAK,CAAC,CAAC,KAAK,CAAC,CAAC,IAAI,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC;CACrC,IAAI,OAAO,CAAC,OAAO,GAAG,QAAQ,CAAC;CAC/B,IAAI,OAAO,CAAC,MAAM,GAAG,QAAQ,CAAC;CAC9B,IAAI,IAAI,EAAE,SAAS,IAAI,OAAO,CAAC,EAAE;CACjC,QAAQ,OAAO,CAAC,OAAO,GAAG,EAAE,IAAI;CAChC,YAAY,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;CAC7B,YAAY,OAAO,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;CAC9B,SAAS,CAAC;CACV,KAAK;CACL,IAAI,OAAO,CAAC,SAAS,GAAG,IAAI,CAAC;CAC7B,IAAI,OAAO,OAAO,CAAC;CACnB,CAAC;CACD,cAAc,GAAG,MAAM,CAAC;CACxB,eAAe,GAAG,MAAM,CAAC;CACzB;;;;;;CC5BA;CAiDO,eAAe,qBAAqB,CAAC,OAAwB;KAClE,MAAM,eAAe,GAAG,OAAO,CAAC,iBAAiB,IAAI,WAAW,CAAC,GAAG,EAAE,CAAA;KACtE,MAAM,EAAE,MAAM,EAAE,OAAO,EAAE,UAAU,EAAE,SAAS,EAAE,OAAO,EAAE,eAAe,EAAE,GAAG,OAAO,CAAA;KACpF,MAAM,kBAAkB,GAAG,CAAC,IAAY,KAAK,IAAI,GAAG,CAAC,IAAI,GAAG,KAAK,GAAG,eAAe,EAAE,OAAO,CAAC,CAAC,QAAQ,EAAE,CAAA;KAExG,MAAM,MAAM,GAAG;SACb,OAAO,EAAE,kBAAkB,CAAC,qBAAqB,CAAC;SAClD,YAAY,EAAE,kBAAkB,CAAC,6BAA6B,CAAC;SAC/D,OAAO,EAAE,kBAAkB,CAAC,qBAAqB,CAAC;SAClD,kBAAkB,EAAE,kBAAkB,CAAC,iBAAiB,CAAC;SACzD,WAAW,EAAE,cAAc;SAC3B,WAAW,EAAE,2BAA2B;SACxC,cAAc,EAAE,KAAK;MACtB,CAAA;KAED,MAAM,mBAAmB,GAAG,MAAM,EAAM,CAIvC;KAAC,UAAkB,CAAC,KAAK,CAAC,GAAG;;SAE5B,aAAa;aACX,mBAAmB,CAAC,OAAO,CAAC,EAAE,CAAC,CAAA;UAChC;;SAGD,iBAAiB,CAAC,IAAY,EAAE,kBAA0B;aACxD,eAAe,CAAC,IAAI,EAAE,kBAAkB,CAAC,CAAA;UAC1C;MACF,CAAA;KAED,MAAM,aAAa,GAAG,MAAM,mBAAmB,CAAC,MAAM,EAAE,MAAM,EAAE,UAAU,EAAE,SAAS,EAAE,OAAO,CAAC,CAAA;;KAI/F,OAAO;SACL,mBAAmB;SACnB,aAAa;MACd,CAAA;CACH;;;;;;;;;;;;"}